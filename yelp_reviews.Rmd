---
title: "yelp_reviews"
author: "Huey"
date: "June 20, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(ggplot2)
library(stringi)

setwd("~/code/yelp")
```

Hypotheses:

* Latinos are more critical of Mexican restaurants than non-Latinos.
* Latinos will like more authentic Mexican restaurants than non-Latinos.

## Load businesses
First, let's load the Yelp businesses. I used the JSON to CSV converter in https://github.com/Yelp/dataset-examples to make it easier for me to load.

```{r load data}
businesses = read_csv("data/yelp_academic_dataset_business.csv")
reviews = read_csv("data/yelp_academic_dataset_review.csv")
users = read_csv("data/yelp_academic_dataset_user.csv")

latino_names = read.csv("popular_names_latino.csv", 
                        encoding = "latin1", stringsAsFactors = FALSE)
latino_names$Male.Name = stri_trans_general(latino_names$Male.Name, 
                                            'latin-ascii')
latino_names$Female.Name = stri_trans_general(latino_names$Female.Name, 
                                              'latin-ascii')

latino_names = as.data.frame(c(latino_names$Male.Name, latino_names$Female.Name), stringsAsFactors = FALSE)
names(latino_names) = "name"
```

## Get Mexican restaurants
Get Mexican restaurants with the most reviews. 
```{r top Mexican restaurants}
mexican = businesses %>% filter(grepl('Mexican', categories)) %>% filter(grepl('Restaurants', categories)) %>% arrange(desc(review_count))
```

## Test on all of them
```{r more restaurants}
num_restaurants = 2515
restaurants = mexican[1:num_restaurants,]
restaurant_reviews = inner_join(restaurants, reviews, by = "business_id")
restaurant_reviews_users = inner_join(restaurant_reviews, users, by = "user_id")
```

t-test the differences
```{r t-test many}
p_value_cutoff = 0.05 / num_restaurants

restaurant_names = c()
latino_ratings = c()
non_latino_ratings = c()
num_latino_reviews = c()
num_non_latino_reviews = c()

for (id in restaurants$business_id) {
  subset = filter(restaurant_reviews_users, business_id == id)
  latino_reviews = semi_join(subset, latino_names, c("name.y" = "name"))
  non_latino_reviews = anti_join(subset, latino_names, c("name.y" = "name"))
  
  if (length(latino_reviews$stars.y) <= 1 || length(non_latino_reviews$stars.y) <= 1) next  # Prevent errors to t-test
  
  try({
    alt = "two.sided"
    latino_mean = mean(latino_reviews$stars.y)
    non_latino_mean = mean(non_latino_reviews$stars.y)
    if (latino_mean < non_latino_mean) {
      alt = "less"
    }
    if (latino_mean > non_latino_mean) {
      alt = "greater"
    }
    #print(length(latino_reviews$stars.y))
    res = t.test(latino_reviews$stars.y, non_latino_reviews$stars.y, alternative = alt)
    if (res$p.value < p_value_cutoff) {
      restaurant_names = c(restaurant_names, subset$name.x[1])
      latino_ratings = c(latino_ratings, latino_mean)
      non_latino_ratings = c(non_latino_ratings, non_latino_mean)
      num_latino_reviews = c(num_latino_reviews, nrow(latino_reviews))
      num_non_latino_reviews = c(num_non_latino_reviews, nrow(non_latino_reviews))
    }
  }
  )
}
restaurants_sig = data.frame(restaurant_names, latino_ratings, non_latino_ratings, num_latino_reviews, num_non_latino_reviews)
```

## Results
The following table shows the restaurants where latino ratings and non-latino ratings
had statistically significant differences:
```{r latino data frame}
restaurants_sig
```

For all of these, the sample size of Latino reviews is really small. It seems that
building a "racist Yelp" for Mexican restaurants would not be all that useful.

## Other Questions
- Is Chipotle more of a lightning rod between Latinos and non-Latinos? 
-- The only time it came up statistically signficant was for two locations, but the number of Latino reviews were small